<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CMake Tutorial | OneStep</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="alternate" type="application/rss+xml" href="https://wmc1999.top/rss.xml" title="OneStep RSS Feed">
    <meta name="description" content="CMake入门教程">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.e4481a5a.css" as="style"><link rel="preload" href="/assets/js/app.f25a4321.js" as="script"><link rel="preload" href="/assets/js/6.036fc43e.js" as="script"><link rel="preload" href="/assets/js/3.e3d55509.js" as="script"><link rel="preload" href="/assets/js/33.89c22683.js" as="script"><link rel="preload" href="/assets/js/9.151ac344.js" as="script"><link rel="prefetch" href="/assets/js/10.e077d793.js"><link rel="prefetch" href="/assets/js/11.93b1eff1.js"><link rel="prefetch" href="/assets/js/12.165a8f38.js"><link rel="prefetch" href="/assets/js/13.86b71190.js"><link rel="prefetch" href="/assets/js/14.f7c31146.js"><link rel="prefetch" href="/assets/js/15.b61267d7.js"><link rel="prefetch" href="/assets/js/16.e7b2390a.js"><link rel="prefetch" href="/assets/js/17.c6ea5fff.js"><link rel="prefetch" href="/assets/js/18.678082c9.js"><link rel="prefetch" href="/assets/js/19.21a8a34e.js"><link rel="prefetch" href="/assets/js/20.9edcae00.js"><link rel="prefetch" href="/assets/js/21.f0f9d500.js"><link rel="prefetch" href="/assets/js/22.b54c9990.js"><link rel="prefetch" href="/assets/js/23.53b24cbf.js"><link rel="prefetch" href="/assets/js/24.659f2811.js"><link rel="prefetch" href="/assets/js/25.d1cafbf8.js"><link rel="prefetch" href="/assets/js/26.b17873ae.js"><link rel="prefetch" href="/assets/js/27.2aa200a3.js"><link rel="prefetch" href="/assets/js/28.15123e9b.js"><link rel="prefetch" href="/assets/js/29.f9430524.js"><link rel="prefetch" href="/assets/js/30.ea435c6a.js"><link rel="prefetch" href="/assets/js/31.cefe08f6.js"><link rel="prefetch" href="/assets/js/32.df4e8226.js"><link rel="prefetch" href="/assets/js/34.431af884.js"><link rel="prefetch" href="/assets/js/35.5b664f83.js"><link rel="prefetch" href="/assets/js/36.f179d54b.js"><link rel="prefetch" href="/assets/js/37.11846bd5.js"><link rel="prefetch" href="/assets/js/4.d1c52263.js"><link rel="prefetch" href="/assets/js/5.ed205acd.js"><link rel="prefetch" href="/assets/js/7.43914937.js"><link rel="prefetch" href="/assets/js/8.21172198.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.dfe54976.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4481a5a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">OneStep </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="nav-item"><a href="/about/" class="nav-link">About </a></li><li class="nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">OneStep </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About </a></li><li class="mobile-nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CMake Tutorial
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-10-29T14:09:24.000Z">
      2020-10-29
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/CMake" data-v-42ccfcd5><span data-v-42ccfcd5>CMake</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>最近因为毕设的原因，需要看 Cpp 项目，首先项目构建就涉及到了 CMake，所以跟着 CMake 官网的 Tutorial 学习了一下，该文章算是官网教程的搬运。
<a href="https://cmake.org/cmake/help/latest/guide/tutorial/index.html" target="_blank" rel="noopener noreferrer">Tutorial 点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/Kitware/CMake/tree/master/Help/guide/tutorial" target="_blank" rel="noopener noreferrer">GitHub 代码点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h1 id="构建简单项目"><a href="#构建简单项目" class="header-anchor">#</a> 构建简单项目</h1> <p>最基本的 CMake 项目是由源代码文件构建可执行文件。对于简单的项目，只需要一个三行的 CMakeLists.txt 文件。这将是我们 tutorial 的起点。</p> <h2 id="开始项目"><a href="#开始项目" class="header-anchor">#</a> 开始项目</h2> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.10</span><span class="token punctuation">)</span>

<span class="token comment"># set the project name</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>Tutorial<span class="token punctuation">)</span>

<span class="token comment"># add the executable</span>
<span class="token keyword">add_executable</span><span class="token punctuation">(</span>Tutorial tutorial.cxx<span class="token punctuation">)</span>
</code></pre></div><p>源代码<code>tutorial.cxx</code>如下</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// A simple program that computes the square root of a number</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Usage: &quot;</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; number&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// convert input to double</span>
  <span class="token keyword">const</span> <span class="token keyword">double</span> inputValue <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// calculate square root</span>
  <span class="token keyword">const</span> <span class="token keyword">double</span> outputValue <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;The square root of &quot;</span> <span class="token operator">&lt;&lt;</span> inputValue <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; is &quot;</span> <span class="token operator">&lt;&lt;</span> outputValue
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="添加版本号并配置头文件"><a href="#添加版本号并配置头文件" class="header-anchor">#</a> 添加版本号并配置头文件</h2> <p>添加版本号</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment">#set the project name and version</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>Tutorial <span class="token property">VERSION</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
</code></pre></div><p>然后，配置一个头文件，将版本号传递给源代码</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">configure_file</span><span class="token punctuation">(</span>TutorialConfig.h.in TutorialConfig.h<span class="token punctuation">)</span>
</code></pre></div><p>由于配置的文件将被写入二叉树，所以我们必须将该目录添加到搜索 include 文件的路径列表中（该声明放在<code>add_executable</code>之后）:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span>
                           <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span>
                           <span class="token punctuation">)</span>
</code></pre></div><p>新建<code>TutorialConfig.h.in</code></p> <div class="language-cmake extra-class"><pre class="language-cmake"><code>// the configured options and settings for Tutorial
<span class="token comment">#define Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@</span>
<span class="token comment">#define Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@</span>
</code></pre></div><p>当 CMake 配置这个头文件时，@Tutorial_VERSION_MAJOR@和@Tutorial_VERSION_MINOR@的值将被替换。</p> <p>接着，修改源代码，include 头文件<code>TutorialConfig.h</code>。然后，更新源代码打印出可执行文件的名称和版本号：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// report version</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; Version &quot;</span> <span class="token operator">&lt;&lt;</span> Tutorial_VERSION_MAJOR <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;.&quot;</span>
              <span class="token operator">&lt;&lt;</span> Tutorial_VERSION_MINOR <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Usage: &quot;</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; number&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>指定使用 C++11 标准，使用<code>std::stod</code></p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.10</span><span class="token punctuation">)</span>

<span class="token comment"># set the project name and version</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>Tutorial <span class="token property">VERSION</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

<span class="token comment"># specify the C++ standard</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD_REQUIRED</span> True<span class="token punctuation">)</span>
</code></pre></div><p>CMAKE_CXX_STANDARD 生命必须放在 add_executable 之前</p> <h2 id="构建并测试"><a href="#构建并测试" class="header-anchor">#</a> 构建并测试</h2> <p>首先构建</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> step1_build
<span class="token builtin class-name">cd</span> step1_build
cmake <span class="token punctuation">..</span>
cmake --build <span class="token builtin class-name">.</span>
</code></pre></div><p>然后测试</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Tutorial <span class="token number">4294967296</span>
Tutorial <span class="token number">10</span>
Tutorial
</code></pre></div><h1 id="添加一个库"><a href="#添加一个库" class="header-anchor">#</a> 添加一个库</h1> <p>我们将向项目中添加一个库。这个库将包含了自定义的平方根函数的实现。之后，在可执行文件中使用用这个库，替换编译器提供的标准平方根函数。</p> <p>新建<code>MathFunctions</code>目录，在其下添加<code>CMakeLists.txt</code>,添加如下内容:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_library</span><span class="token punctuation">(</span>MathFunctions mysqrt.cxx<span class="token punctuation">)</span>
</code></pre></div><p><code>mysqrt.cxx</code>如下：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token comment">// a hack square root calculation using simple operations</span>
<span class="token keyword">double</span> <span class="token function">mysqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> result <span class="token operator">=</span> x<span class="token punctuation">;</span>

    <span class="token comment">// do ten iterations</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">double</span> delta <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token punctuation">(</span>result <span class="token operator">*</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> delta <span class="token operator">/</span> result<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Computing sqrt of &quot;</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; to be &quot;</span> <span class="token operator">&lt;&lt;</span> result
                  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>为了使用新库，我们将在顶层的<code>CMakeLists.txt</code>文件中添加一个<code>add subdirectory()</code>调用，以便构建库。我们将新库添加到可执行文件中，并将<code>MathFunctions</code>添加为 include 目录，以便可以找到<code>mqsqrt.h</code>头文件。顶层的<code>CMakeLists.txt</code>文件的最后几行现在看起来应该是这样的：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># add the MathFunctions library</span>
<span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>MathFunctions<span class="token punctuation">)</span>

<span class="token comment"># add the executable</span>
<span class="token keyword">add_executable</span><span class="token punctuation">(</span>Tutorial tutorial.cxx<span class="token punctuation">)</span>

<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span> MathFunctions<span class="token punctuation">)</span>

<span class="token comment"># add the binary tree to the search path for include files</span>
<span class="token comment"># so that we will find TutorialConfig.h</span>
<span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span>
                          <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span>
                          <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/MathFunctions&quot;</span>
                          <span class="token punctuation">)</span>
</code></pre></div><p>现在让我们把 MathFunctions 库变成可选的。虽然对于本教程来说，没有必要这样做，但对于大型项目来说，这是一种常见的情况。第一步是在顶层的 CMakeLists.txt 文件中添加一个选项（<code>option</code>放在<code>configure_file</code>前面）:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">option</span><span class="token punctuation">(</span>USE_MYMATH <span class="token string">&quot;Use tutorial provided math implementation&quot;</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>

<span class="token comment"># configure a header file to pass some of the CMake settings</span>
<span class="token comment"># to the source code</span>
<span class="token keyword">configure_file</span><span class="token punctuation">(</span>TutorialConfig.h.in TutorialConfig.h<span class="token punctuation">)</span>
</code></pre></div><p>这个选项会在 <code>cmake-gui</code> 和 <code>ccmake</code> 中显示，默认值为 ON，用户可以更改。这个设置将被保存在缓存中，这样用户就不需要在每次运行 CMake 的时候设置这个值。</p> <p>下一个步是使构建和链接<code>MathFunctions</code>库成为条件判断的。要做到这一点，我们将顶层<code>CMakeLists.txt</code>文件的结尾改为如下所示:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">if</span><span class="token punctuation">(</span>USE_MYMATH<span class="token punctuation">)</span>
  <span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>MathFunctions<span class="token punctuation">)</span>
  <span class="token keyword">list</span><span class="token punctuation">(</span>APPEND EXTRA_LIBS MathFunctions<span class="token punctuation">)</span>
  <span class="token keyword">list</span><span class="token punctuation">(</span>APPEND EXTRA_INCLUDES <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/MathFunctions&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># add the executable</span>
<span class="token keyword">add_executable</span><span class="token punctuation">(</span>Tutorial tutorial.cxx<span class="token punctuation">)</span>

<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span> <span class="token punctuation">${</span>EXTRA_LIBS<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># add the binary tree to the search path for include files</span>
<span class="token comment"># so that we will find TutorialConfig.h</span>
<span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span>
                           <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span>
                           <span class="token punctuation">${</span>EXTRA_INCLUDES<span class="token punctuation">}</span>
                           <span class="token punctuation">)</span>
</code></pre></div><p>请注意使用变量<code>EXTRA_LIBS</code>来收集任何可选的库，以便以后链接到可执行文件中。变量<code>EXTRA_INCLUDES</code>也同样用于处理可选的头文件。这是在处理许多可选组件时的传统方法，下一步讲介绍更为现代化方法。</p> <p>相应的，需要简单修改源代码。首先，在<code>tutorial.cxx</code>中，如果我们需要的话，就加入<code>MathFunctions.h</code>头文件：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_MYMATH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">include</span> <span class="token string">&quot;MathFunctions.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p>然后，使用<code>USE_MYMATH</code>控制库函数的调用：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_MYMATH</span></span>
  <span class="token keyword">const</span> <span class="token keyword">double</span> outputValue <span class="token operator">=</span> <span class="token function">mysqrt</span><span class="token punctuation">(</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token keyword">const</span> <span class="token keyword">double</span> outputValue <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p>由于源代码现在需要 <code>USE_MYMATH</code>， 我们可以在 <code>TutorialConfig.h.in</code>中加入下面这行:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">cmakedefine</span> <span class="token expression">USE_MYMATH</span></span>
</code></pre></div><p>接下来，在构建时，可以使用<code>-D</code>添加使用选项，例如要关闭选项，使用：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cmake <span class="token punctuation">..</span> -DUSE_MYMATH<span class="token operator">=</span>OFF
</code></pre></div><h1 id="添加库的使用条件"><a href="#添加库的使用条件" class="header-anchor">#</a> 添加库的使用条件</h1> <p>使用条件允许更好地控制库或可执行文件的链接和<code>include</code>行，同时也给予 CMake 内部 target 的转义属性更多的控制。利用使用条件的主要命令有:</p> <ul><li><a href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html#command:target_compile_definitions" target="_blank" rel="noopener noreferrer"><code>target_compile_definitions()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cmake.org/cmake/help/latest/command/target_compile_options.html#command:target_compile_options" target="_blank" rel="noopener noreferrer"><code>target_compile_options()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html#command:target_include_directories" target="_blank" rel="noopener noreferrer"><code>target_include_directories()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html#command:target_link_libraries" target="_blank" rel="noopener noreferrer"><code>target_link_libraries()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>让我们从步骤 2 开始中重构我们的代码，使用现代 CMake 的使用条件方法。我们首先声明，任何人链接到<code>MathFunctions</code>都需要包含当前目录，而<code>MathFunctions</code>本身不需要。所以这可以成为一个<code>INTERFACE</code>的使用条件。</p> <p>记住，<code>INTERFACE</code>是指使用者需要而提供者不需要的东西。在<code>MathFunctions/CMakeLists.txt</code>的末尾添加以下几行:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>MathFunctions
          <span class="token namespace">INTERFACE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
</code></pre></div><p>现在我们已经指定了 <code>MathFunctions</code>的使用条件，我们可以安全地从顶层的 <code>CMakeLists.txt</code>中删除对 <code>EXTRA_INCLUDES</code> 变量的使用。</p> <p>此处</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">if</span><span class="token punctuation">(</span>USE_MYMATH<span class="token punctuation">)</span>
    <span class="token comment"># add the MathFunctions library</span>
    <span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>MathFunctions<span class="token punctuation">)</span>
    <span class="token keyword">list</span><span class="token punctuation">(</span>APPEND EXTRA_LIBS MathFunctions<span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>和此处</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span>
                           <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span>
                           <span class="token punctuation">)</span>
</code></pre></div><p>之后便可以重新构建项目了。</p> <h1 id="安装和测试"><a href="#安装和测试" class="header-anchor">#</a> 安装和测试</h1> <p>现在我们可以开始为我们的项目添加安装规则和测试支持。</p> <h2 id="安装规则"><a href="#安装规则" class="header-anchor">#</a> 安装规则</h2> <p>安装规则相当简单：对于<code>MathFunctions</code>，我们要安装库和头文件，对于应用程序，我们要安装可执行文件和配置的头文件。</p> <p>所以在<code>MathFunctions/CMakeLists.txt</code>中添加：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">install</span><span class="token punctuation">(</span>TARGETS MathFunctions DESTINATION lib<span class="token punctuation">)</span>
<span class="token keyword">install</span><span class="token punctuation">(</span>FILES MathFunctions.h DESTINATION include<span class="token punctuation">)</span>
</code></pre></div><p>在顶层的<code>CMakeLists.txt</code>中 添加：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">install</span><span class="token punctuation">(</span>TARGETS Tutorial DESTINATION bin<span class="token punctuation">)</span>
<span class="token keyword">install</span><span class="token punctuation">(</span>FILES <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>/TutorialConfig.h&quot;</span>
  DESTINATION include
  <span class="token punctuation">)</span>
</code></pre></div><p>这就是为<code>tutorial</code>创建一个基本的本地安装所需要的全部内容。</p> <p>现在重新来配置项目并构建它。然后在命令行使用<code>cmake</code> 命令的<code>install</code> 选项来运行安装步骤 (在 3.15 中引入，旧版本的 CMake 必须使用 make install)。对于多配置工具，不要忘记使用--config 参数来指定配置。如果使用 IDE，只需构建<code>INSTALL</code> target。这一步将安装相应的头文件、库和可执行文件。例如:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cmake --install <span class="token builtin class-name">.</span>
</code></pre></div><p>CMake 变量 <code>CMAKE_INSTALL_PREFIX</code> 用于确定文件安装的根目录。如果使用 <code>cmake --install</code> 命令，安装目录可以通过 <code>--prefix</code>参数重写。例如：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cmake --install <span class="token builtin class-name">.</span> --prefix <span class="token string">&quot;/home/myuser/installdir&quot;</span>
</code></pre></div><h2 id="测试支持"><a href="#测试支持" class="header-anchor">#</a> 测试支持</h2> <p>接下来，测试我们的应用程序。在顶层的<code>CMakeLists.txt</code>文件的末尾，我们可以启用测试，然后添加一些基本测试以验证应用程序是否正常运行。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">enable_testing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># does the application run</span>
<span class="token keyword">add_test</span><span class="token punctuation">(</span><span class="token property">NAME</span> Runs COMMAND Tutorial <span class="token number">25</span><span class="token punctuation">)</span>

<span class="token comment"># does the usage message work?</span>
<span class="token keyword">add_test</span><span class="token punctuation">(</span><span class="token property">NAME</span> Usage COMMAND Tutorial<span class="token punctuation">)</span>
<span class="token keyword">set_tests_properties</span><span class="token punctuation">(</span>Usage
  <span class="token namespace">PROPERTIES</span> <span class="token property">PASS_REGULAR_EXPRESSION</span> <span class="token string">&quot;Usage:.*number&quot;</span>
  <span class="token punctuation">)</span>

<span class="token comment"># define a function to simplify adding tests</span>
<span class="token keyword">function</span><span class="token punctuation">(</span>do_test target arg result<span class="token punctuation">)</span>
  <span class="token keyword">add_test</span><span class="token punctuation">(</span><span class="token property">NAME</span> Comp<span class="token punctuation">${</span>arg<span class="token punctuation">}</span> COMMAND <span class="token punctuation">${</span>target<span class="token punctuation">}</span> <span class="token punctuation">${</span>arg<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">set_tests_properties</span><span class="token punctuation">(</span>Comp<span class="token punctuation">${</span>arg<span class="token punctuation">}</span>
    <span class="token namespace">PROPERTIES</span> <span class="token property">PASS_REGULAR_EXPRESSION</span> <span class="token punctuation">${</span>result<span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token keyword">endfunction</span><span class="token punctuation">(</span>do_test<span class="token punctuation">)</span>

<span class="token comment"># do a bunch of result based tests</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">4</span> <span class="token string">&quot;4 is 2&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">9</span> <span class="token string">&quot;9 is 3&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">5</span> <span class="token string">&quot;5 is 2.236&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">7</span> <span class="token string">&quot;7 is 2.645&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">25</span> <span class="token string">&quot;25 is 5&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial -<span class="token number">25</span> <span class="token string">&quot;-25 is [-nan|nan|0]&quot;</span><span class="token punctuation">)</span>
<span class="token function">do_test</span><span class="token punctuation">(</span>Tutorial <span class="token number">0.0001</span> <span class="token string">&quot;0.0001 is 0.01&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>第一个测试只是简单地验证应用程序是否运行，没有 segfault 或其他崩溃，并且返回值为零。这是 CTest 测试的基本形式。</p> <p>下一个测试利用<code>PASS_REGULAR_EXPRESSION</code>测试属性来验证测试的输出是否包含某些字符串。在这种情况下，验证当提供的参数数量不正确时，是否会打印出使用信息。</p> <p>最后，我们有一个名为 do_test 的函数，它运行应用程序并验证给定输入的计算平方根是否正确。每调用一次<code>do_test</code>，就会在项目中添加一个测试，包括名称、输入和基于传递的参数的预期结果。</p> <p>重新构建应用程序，然后 cd 到二进制目录，运行<code>ctest</code>可执行文件：<code>ctest -N</code>（<code>--show-only[=format]</code>）和<code>ctest -VV</code>（<code>--extra-verbose</code>）。对于多配置生成器（如 Visual Studio），必须指定配置类型。例如，要在 Debug 模式下运行测试，从构建目录中使用<code>ctest -C Debug -VV</code>（不是 Debug 子目录！）。或者，从 IDE 中构建<code>RUN_TESTS</code>目标。</p> <h1 id="添加系统自检"><a href="#添加系统自检" class="header-anchor">#</a> 添加系统自检</h1> <p>让我们考虑在我们的项目中添加一些代码，这些代码取决于目标平台可能没有的功能。在这个例子中，我们将添加一些代码，这些代码取决于目标平台是否有 log 和 exp 函数。当然，几乎每个平台都有这些函数，但在本教程中，假设它们并不常见。</p> <p>如果平台上有 log 和 exp，那么我们将使用它们来计算 mysqrt 函数中的平方根。我们首先使用顶层<code>CMakeLists.txt</code>中的<code>CheckSymbolExists</code>模块测试这些函数是否可用。在某些平台上，我们需要链接到<code>m</code>库。如果最初没有找到<code>log</code>和<code>exp</code>，则需要使用<code>m</code>库并再次尝试。</p> <p>我们将使用<code>TutorialConfig.h.in</code>中的新定义，所以一定要在配置该文件之前设置它们。</p> <p>如果系统上有<code>log</code>和<code>exp</code>，那么我们将在<code>mysqrt</code>函数中使用它们来计算平方根。在<code>MathFunctions/mysqrt.cxx</code>中的<code>mysqrt</code>函数中添加以下代码（在返回结果之前不要忘记<code>#endif</code>！）。</p> <p>重新构建项目，会发现无论平台上是否有<code>log</code>和<code>exp</code>，都不会调用它们。因为我们忘记了在<code>mysqrt.cxx</code>中 include <code>TutorialConfig.h</code>。现在更新</p> <p>我们还需要更新<code>MathFunctions / CMakeLists.txt</code>，以便<code>mysqrt.cxx</code>知道此文件的位置：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>MathFunctions
          <span class="token namespace">INTERFACE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>
          <span class="token namespace">PRIVATE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_BINARY_DIR</span><span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
</code></pre></div><h2 id="指定编译定义"><a href="#指定编译定义" class="header-anchor">#</a> 指定编译定义</h2> <p>除了在<code>TutorialConfig.h</code>中保存<code>HAVE_LOG</code>和<code>HAVE_EXP</code>值，我们还有更好的方法吗？让我们尝试使用<code>target_compile_definitions()</code>。</p> <p>首先，从<code>TutorialConfig.h.in</code>中删除定义。我们不再需要在<code>mysqrt.cxx</code>中 include <code>TutorialConfig.h</code>或<code>MathFunctions/CMakeLists.txt</code>中的其他 include 内容。</p> <p>接下来，我们可以将<code>HAVE_LOG</code>和<code>HAVE_EXP</code>的检查移至<code>MathFunctions/CMakeLists.txt</code>，然后将这些值指定为<code>PRIVATE</code>编译定义。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">include</span><span class="token punctuation">(</span>CheckSymbolExists<span class="token punctuation">)</span>
<span class="token function">check_symbol_exists</span><span class="token punctuation">(</span>log <span class="token string">&quot;math.h&quot;</span> HAVE_LOG<span class="token punctuation">)</span>
<span class="token function">check_symbol_exists</span><span class="token punctuation">(</span>exp <span class="token string">&quot;math.h&quot;</span> HAVE_EXP<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token punctuation">(</span>HAVE_LOG <span class="token operator">AND</span> HAVE_EXP<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">unset</span><span class="token punctuation">(</span>HAVE_LOG <span class="token variable">CACHE</span><span class="token punctuation">)</span>
  <span class="token keyword">unset</span><span class="token punctuation">(</span>HAVE_EXP <span class="token variable">CACHE</span><span class="token punctuation">)</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_REQUIRED_LIBRARIES</span> <span class="token string">&quot;m&quot;</span><span class="token punctuation">)</span>
  <span class="token function">check_symbol_exists</span><span class="token punctuation">(</span>log <span class="token string">&quot;math.h&quot;</span> HAVE_LOG<span class="token punctuation">)</span>
  <span class="token function">check_symbol_exists</span><span class="token punctuation">(</span>exp <span class="token string">&quot;math.h&quot;</span> HAVE_EXP<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_LOG <span class="token operator">AND</span> HAVE_EXP<span class="token punctuation">)</span>
    <span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>MathFunctions <span class="token namespace">PRIVATE</span> m<span class="token punctuation">)</span>
  <span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># add compile definitions</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_LOG <span class="token operator">AND</span> HAVE_EXP<span class="token punctuation">)</span>
  <span class="token keyword">target_compile_definitions</span><span class="token punctuation">(</span>MathFunctions
                             <span class="token namespace">PRIVATE</span> <span class="token string">&quot;HAVE_LOG&quot;</span> <span class="token string">&quot;HAVE_EXP&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>之后再重新构建并运行项目，查看结果。</p> <h1 id="添加自定义命令和生成的文件"><a href="#添加自定义命令和生成的文件" class="header-anchor">#</a> 添加自定义命令和生成的文件</h1> <p>假设，作为本教程的目的，我们决定永远不要使用平台提供的<code>log</code>和<code>exp</code>函数，而是想生成一个预计算值的表，以便在<code>mysqrt</code>函数中使用。在本节中，我们将创建该表作为构建过程的一部分，然后将该表编译到我们的应用程序中。</p> <p>首先，让我们删除<code>MathFunctions/CMakeLists.txt</code>中对<code>log</code>和<code>exp</code>函数的检查。然后从<code>mysqrt.cxx</code>中删除对<code>HAVE_LOG</code>和<code>HAVE_EXP</code>的检查。同时，我们可以删除<code>#include</code> 。</p> <p>在<code>MathFunctions</code>子目录中，提供了一个名为<code>MakeTable.cxx</code>的新源文件来生成表。</p> <p>查看完文件后，我们可以看到该表是作为有效的 C ++代码生成的，并且输出文件名作为参数传入。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// A simple program that builds a sqrt table</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// make sure we have enough arguments</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>ofstream <span class="token function">fout</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">::</span>ios_base<span class="token operator">::</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> fileOpen <span class="token operator">=</span> fout<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;double sqrtTable[] = {&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fout <span class="token operator">&lt;&lt;</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// close the table with a zero</span>
        fout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;0};&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fileOpen <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// return 0 if wrote the file</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下一步是将适当的命令添加到<code>MathFunctions/CMakeLists.txt</code>文件中，以构建<code>MakeTable</code>可执行文件，然后在构建过程中运行它。需要一些命令来完成此操作。</p> <p>首先，在<code>MathFunctions/CMakeLists.txt</code>的顶部，添加<code>MakeTable</code>的可执行文件，就像添加任何其他可执行文件一样。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_executable</span><span class="token punctuation">(</span>MakeTable MakeTable.cxx<span class="token punctuation">)</span>
</code></pre></div><p>然后，我们添加一个自定义命令，该命令指定如何通过运行<code>MakeTable</code>来产生<code>Table.h</code>。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_custom_command</span><span class="token punctuation">(</span>
  OUTPUT <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
  COMMAND MakeTable <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
  <span class="token property">DEPENDS</span> MakeTable
  <span class="token punctuation">)</span>
</code></pre></div><p>接下来，我们必须让 CMake 知道<code>mysqrt.cxx</code>如何依赖生成的文件<code>Table.h</code>。通过将生成的<code>Table.h</code>添加到库<code>MathFunctions</code>的源列表中，可以完成此操作。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_library</span><span class="token punctuation">(</span>MathFunctions
            mysqrt.cxx
            <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
            <span class="token punctuation">)</span>
</code></pre></div><p>我们还必须将当前的二进制目录添加到包含目录列表中，以便<code>mysqrt.cxx</code>可以找到并包含<code>Table.h</code>。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>MathFunctions
          <span class="token namespace">INTERFACE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>
          <span class="token namespace">PRIVATE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
</code></pre></div><p>现在，我们使用生成的表。首先，修改<code>mysqrt.cxx</code>以包含<code>Table.h</code>。接下来，我们可以重写<code>mysqrt</code>函数以使用该表：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;MathFunctions.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Table.h&quot;</span></span>

<span class="token keyword">double</span> <span class="token function">mysqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// use the table to help find an initial value</span>
    <span class="token keyword">double</span> result <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Use the table to help find an initial value &quot;</span>
                  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        result <span class="token operator">=</span> sqrtTable<span class="token punctuation">[</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// do ten iterations</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">double</span> delta <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token punctuation">(</span>result <span class="token operator">*</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> delta <span class="token operator">/</span> result<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Computing sqrt of &quot;</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; to be &quot;</span> <span class="token operator">&lt;&lt;</span> result
                  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>构建此项目时，它将首先构建<code>MakeTable</code>可执行文件。然后它将运行<code>MakeTable</code>生成<code>Table.h</code>。最后，它将编译包括<code>Table.h</code>的<code>mysqrt.cxx</code>，以生成<code>MathFunctions</code>库。</p> <p>做完这些更新后，再继续构建项目。运行构建好的 Tutorial 可执行文件，并验证结果是否与前面相同。</p> <h1 id="构建安装程序"><a href="#构建安装程序" class="header-anchor">#</a> 构建安装程序</h1> <p>接下来假设我们想把我们的项目发布给其他人，以便他们能够使用它。我们希望在不同的平台上提供二进制和源代码的发布。这与我们之前在安装和测试（第 4 步）中所做的安装有些不同，在这里我们安装的是我们从源代码中构建的二进制文件。在这个例子中，我们将构建支持二进制安装和包管理功能的安装包。为了完成这个任务，我们将使用<code>CPack</code>来创建特定平台的安装包。具体来说，我们需要在顶层<code>CMakeLists.txt</code>文件的底部添加几行内容:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">include</span><span class="token punctuation">(</span>InstallRequiredSystemLibraries<span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>CPACK_RESOURCE_FILE_LICENSE <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/License.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CPACK_PACKAGE_VERSION_MAJOR</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">Tutorial_VERSION_MAJOR</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CPACK_PACKAGE_VERSION_MINOR</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">Tutorial_VERSION_MINOR</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">include</span><span class="token punctuation">(</span>CPack<span class="token punctuation">)</span>
</code></pre></div><p>首先包含<code>InstallRequiredSystemLibraries</code>。这个模块将包含项目在当前平台上需要的任何运行时库。接下来，我们设置一些<code>CPack</code>变量，将这个项目的许可证和版本信息存储在那里。版本信息在本教程的前面已经设置好了，<code>license.txt</code>已经包含在本步骤的顶层源目录中:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>This is the <span class="token function">open</span> <span class="token builtin class-name">source</span> License.txt <span class="token function">file</span> introduced <span class="token keyword">in</span>
CMake/Tutorial/Step7<span class="token punctuation">..</span>.
</code></pre></div><p>最后我们加入<code>CPack</code>模块，它将使用这些变量和当前系统的一些其他属性来设置安装程序。</p> <p>下一步是以通常的方式构建项目，然后运行<code>cpack</code>可执行文件。要构建一个二进制发行版，请在二进制目录下运行。</p> <p>要指定生成器，请使用<code>-G</code>选项。对于多配置的构建，使用<code>-C</code>来指定配置。例如：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cpack -G ZIP -C Debug
</code></pre></div><p>要创建一个源码分发，可以输入：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cpack --config CPackSourceConfig.cmake
</code></pre></div><p>或者，运行<code>make package</code>或右键点击<code>Package</code> target 并从 IDE 中构建项目。</p> <p>运行在二进制目录下找到的安装程序。然后运行已安装的可执行文件，并验证它是否工作。</p> <h1 id="添加-dashboard-支持"><a href="#添加-dashboard-支持" class="header-anchor">#</a> 添加 DashBoard 支持</h1> <p>添加支持将我们的测试结果提交到 dashboard 很简单。我们已经为我们的项目定义了一些测试。现在我们只需要运行这些测试并将它们提交到仪表板。为了包含对仪表盘的支持，我们在顶层的<code>CMakeLists.txt</code>中加入了<code>CTest</code>模块:</p> <p>将<code>enable_testing()</code>替换为<code>include(CTest)</code>。</p> <p><code>CTest</code>模块会自动调用<code>enable_testing()</code>，所以我们可以从<code>CMake</code>文件中删除它。</p> <p>我们还需要在顶层目录下创建一个<code>CTestConfig.cmake</code>文件，在这里我们可以指定项目的名称和提交<code>dashboard</code>的位置。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">set</span><span class="token punctuation">(</span>CTEST_PROJECT_NAME <span class="token string">&quot;CMakeTutorial&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CTEST_NIGHTLY_START_TIME</span> <span class="token string">&quot;00:00:00 EST&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CTEST_DROP_METHOD</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CTEST_DROP_SITE</span> <span class="token string">&quot;my.cdash.org&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CTEST_DROP_LOCATION</span> <span class="token string">&quot;/submit.php?project=CMakeTutorial&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CTEST_DROP_SITE_CDASH</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
</code></pre></div><p>当<code>ctest</code>可执行文件运行时，它将读取这个文件。要创建一个简单的 dashboard，你可以运行<code>cmake</code>可执行文件或<code>cmake-gui</code>来配置项目，但先不要构建它。切换到二叉树状目录，然后运行。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ctest <span class="token punctuation">[</span>-VV<span class="token punctuation">]</span> -D Experimental
</code></pre></div><p>请记住，对于多配置生成器（如 Visual Studio），必须指定配置类型。</p> <h1 id="混合静态和共享"><a href="#混合静态和共享" class="header-anchor">#</a> 混合静态和共享</h1> <p>在这一节中，将展示如何使用<code>BUILD_SHARED_LIBS</code>变量来控制<code>add_library()</code>的默认行为，并允许控制没有明确类型(<code>STATIC, SHARED, MODULE or OBJECT</code>)的库的构建方式。</p> <p>为了达到这个目的，我们需要在顶层的<code>CMakeLists.txt</code>中添加<code>BUILD_SHARED_LIBS</code>。我们使用<code>option()</code>命令，因为它允许用户选择性地选择该值是否应该是 ON 或 OFF。</p> <p>接下来我们将重构 <code>MathFunctions</code>， 使其成为一个真正的库， 封装使用 <code>mysqrt</code> 或 <code>sqrt</code>， 而不是要求调用代码来完成这个逻辑。这也意味着 <code>USE_MYMATH</code>将不会控制构建 <code>MathFunctions</code>，而是控制这个库的行为。</p> <p>第一步是更新顶层<code>CMakeLists.txt</code>的起始部分， 使其看起来像这样:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.10</span><span class="token punctuation">)</span>

<span class="token comment"># set the project name and version</span>
<span class="token keyword">project</span><span class="token punctuation">(</span>Tutorial <span class="token property">VERSION</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

<span class="token comment"># specify the C++ standard</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD_REQUIRED</span> True<span class="token punctuation">)</span>

<span class="token comment"># control where the static and shared libraries are built so that on windows</span>
<span class="token comment"># we don't need to tinker with the path to run the executable</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_LIBRARY_OUTPUT_DIRECTORY</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">option</span><span class="token punctuation">(</span><span class="token variable">BUILD_SHARED_LIBS</span> <span class="token string">&quot;Build using shared libraries&quot;</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>

<span class="token comment"># configure a header file to pass the version number only</span>
<span class="token keyword">configure_file</span><span class="token punctuation">(</span>TutorialConfig.h.in TutorialConfig.h<span class="token punctuation">)</span>

<span class="token comment"># add the MathFunctions library</span>
<span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>MathFunctions<span class="token punctuation">)</span>

<span class="token comment"># add the executable</span>
<span class="token keyword">add_executable</span><span class="token punctuation">(</span>Tutorial tutorial.cxx<span class="token punctuation">)</span>
<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span> MathFunctions<span class="token punctuation">)</span>
</code></pre></div><p>现在我们已经让<code>MathFunctions</code>始终被使用，接下来需要更新该库的逻辑。因此， 在 <code>MathFunctions/CMakeLists.txt</code>中， 我们需要创建一个 <code>SqrtLibrary</code>， 当 <code>USE_MYMATH</code> 启用时， 这个<code>SqrtLibrary</code>将有条件地被构建和安装。由于这是一个教程， 我们将明确要求静态地构建 <code>SqrtLibrary</code>。</p> <p>最终的结果是<code>MathFunctions/CMakeLists.txt</code> 应该是这样的:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># add the library that runs</span>
<span class="token keyword">add_library</span><span class="token punctuation">(</span>MathFunctions MathFunctions.cxx<span class="token punctuation">)</span>

<span class="token comment"># state that anybody linking to us needs to include the current source dir</span>
<span class="token comment"># to find MathFunctions.h, while we don't.</span>
<span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>MathFunctions
                           <span class="token namespace">INTERFACE</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>
                           <span class="token punctuation">)</span>

<span class="token comment"># should we use our own math functions</span>
<span class="token keyword">option</span><span class="token punctuation">(</span>USE_MYMATH <span class="token string">&quot;Use tutorial provided math implementation&quot;</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>USE_MYMATH<span class="token punctuation">)</span>

  <span class="token keyword">target_compile_definitions</span><span class="token punctuation">(</span>MathFunctions <span class="token namespace">PRIVATE</span> <span class="token string">&quot;USE_MYMATH&quot;</span><span class="token punctuation">)</span>

  <span class="token comment"># first we add the executable that generates the table</span>
  <span class="token keyword">add_executable</span><span class="token punctuation">(</span>MakeTable MakeTable.cxx<span class="token punctuation">)</span>

  <span class="token comment"># add the command to generate the source code</span>
  <span class="token keyword">add_custom_command</span><span class="token punctuation">(</span>
    OUTPUT <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
    COMMAND MakeTable <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
    <span class="token property">DEPENDS</span> MakeTable
    <span class="token punctuation">)</span>

  <span class="token comment"># library that just does sqrt</span>
  <span class="token keyword">add_library</span><span class="token punctuation">(</span>SqrtLibrary <span class="token namespace">STATIC</span>
              mysqrt.cxx
              <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/Table.h
              <span class="token punctuation">)</span>

  <span class="token comment"># state that we depend on our binary dir to find Table.h</span>
  <span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>SqrtLibrary <span class="token namespace">PRIVATE</span>
                             <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>
                             <span class="token punctuation">)</span>

  <span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>MathFunctions <span class="token namespace">PRIVATE</span> SqrtLibrary<span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># define the symbol stating we are using the declspec(dllexport) when</span>
<span class="token comment"># building on windows</span>
<span class="token keyword">target_compile_definitions</span><span class="token punctuation">(</span>MathFunctions <span class="token namespace">PRIVATE</span> <span class="token string">&quot;EXPORTING_MYMATH&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># install rules</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>installable_libs MathFunctions<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>TARGET SqrtLibrary<span class="token punctuation">)</span>
  <span class="token keyword">list</span><span class="token punctuation">(</span>APPEND installable_libs SqrtLibrary<span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">install</span><span class="token punctuation">(</span>TARGETS <span class="token punctuation">${</span>installable_libs<span class="token punctuation">}</span> DESTINATION lib<span class="token punctuation">)</span>
<span class="token keyword">install</span><span class="token punctuation">(</span>FILES MathFunctions.h DESTINATION include<span class="token punctuation">)</span>

</code></pre></div><p>接下来，更新 <code>MathFunctions/mysqrt.cxx</code>，使用 <code>mathfunctions</code>和 <code>detail</code> 命名空间。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;MathFunctions.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Table.h&quot;</span></span>

<span class="token keyword">namespace</span> mathfunctions <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> detail <span class="token punctuation">{</span>
<span class="token keyword">double</span> <span class="token function">mysqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> result <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Use the table to help find an initial value &quot;</span>
                  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        result <span class="token operator">=</span> sqrtTable<span class="token punctuation">[</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// do ten iterations</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">double</span> delta <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token punctuation">(</span>result <span class="token operator">*</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> delta <span class="token operator">/</span> result<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Computing sqrt of &quot;</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; to be &quot;</span> <span class="token operator">&lt;&lt;</span> result
                  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">// namespace detail</span>
<span class="token punctuation">}</span> <span class="token comment">// namespace mathfunctions</span>
</code></pre></div><p>我们还需要在 <code>tutorial.cxx</code>中做一些修改， 使它不再使用 <code>USE_MYMATH</code>:</p> <ul><li><p>始终 include <code>MathFunctions.h</code></p></li> <li><p>始终使用 <code>mathfunctions::sqrt</code></p></li> <li><p>不要 include <code>cmath</code></p></li></ul> <p><code>mysqrt.h</code>如下：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">namespace</span> mathfunctions <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> detail <span class="token punctuation">{</span>
<span class="token keyword">double</span> <span class="token function">mysqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">// namespace mathfunctions</span>

</code></pre></div><p><code>MathFunctions.cxx</code>如下：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;MathFunctions.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_MYMATH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;mysqrt.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">namespace</span> mathfunctions <span class="token punctuation">{</span>
<span class="token keyword">double</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_MYMATH</span></span>
    <span class="token keyword">return</span> detail<span class="token operator">::</span><span class="token function">mysqrt</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">// namespace mathfunctions</span>

</code></pre></div><p>最后，更新<code>MathFunctions/MathFunctions.h</code>，使用 dll 导出定义：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_WIN32<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>EXPORTING_MYMATH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECLSPEC</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECLSPEC</span> <span class="token expression"><span class="token function">__declspec</span><span class="token punctuation">(</span>dllimport<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">// non windows</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECLSPEC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">namespace</span> mathfunctions <span class="token punctuation">{</span>
<span class="token keyword">double</span> DECLSPEC <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时，如果你构建了所有的东西，你可能会注意到链接失败，因为我们将一个没有地址无关代码的静态库与一个有地址无关的库结合在一起。解决这个问题的方法是，无论构建类型如何，都要显式地将<code>SqrtLibrary</code>的<code>POSITION_INDEPENDENT_CODE</code>目标属性设置为 True。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># state that SqrtLibrary need PIC when the default is shared libraries</span>
<span class="token keyword">set_target_properties</span><span class="token punctuation">(</span>SqrtLibrary <span class="token namespace">PROPERTIES</span>
											<span class="token property">POSITION_INDEPENDENT_CODE</span> <span class="token punctuation">${</span><span class="token variable">BUILD_SHARED_LIBS</span><span class="token punctuation">}</span>
											<span class="token punctuation">)</span>

<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>MathFunctions <span class="token namespace">PRIVATE</span> SqrtLibrary<span class="token punctuation">)</span>
</code></pre></div><h1 id="添加生成器表达式"><a href="#添加生成器表达式" class="header-anchor">#</a> 添加生成器表达式</h1> <p>在构建系统生成期间会执行<code>Generator expression</code>，以生成特定于每个构建配置的信息。</p> <p>在许多目标属性（例如<code>LINK_LIBRARIES</code>，<code>INCLUDE_DIRECTORIES</code>，<code>COMPLIE_DEFINITIONS</code>等）的上下文中允许<code>Generator expression</code>。在使用命令填充这些属性（例如<code>target_link_libraries()</code>，<code>target_include_directories()</code>，<code>target_compile_definitions()</code>等）时，也可以使用它们。</p> <p><code>Generator expression</code>可用于启用条件链接、编译时使用的条件定义、条件 include 目录等。这些条件可以基于构建配置、目标属性、平台信息或任何其他可查询的信息。</p> <p>有不同类型的<code>Generator expression</code>，包括逻辑表达式、信息表达式和输出表达式。</p> <p>逻辑表达式用于创建条件输出。基本的表达式是 0 和 1 表达式。<code>$&lt;0:...&gt;</code>的结果是空字符串，<code>&lt;1:...&gt;</code>的结果是<code>&quot;... &quot;</code>的内容。它们也可以嵌套。</p> <p><code>Generator expression</code>的一个常见用法是有条件地添加编译器标志，例如语言级别或警告的标志。一个很好的模式是将这些信息关联到一个<code>INTERFACE</code>目标，允许这些信息传播。让我们从构造一个<code>INTERFACE</code>目标开始，并指定所需的 C++标准为 11，而不是使用<code>CMAKE_CXX_STANDARD</code>。</p> <p>原代码如下：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># specify the C++ standard</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD_REQUIRED</span> True<span class="token punctuation">)</span>
</code></pre></div><p>替换为：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_library</span><span class="token punctuation">(</span>tutorial_compiler_flags <span class="token namespace">INTERFACE</span><span class="token punctuation">)</span>
<span class="token keyword">target_compile_features</span><span class="token punctuation">(</span>tutorial_compiler_flags <span class="token namespace">INTERFACE</span> <span class="token property">cxx_std_11</span><span class="token punctuation">)</span>
</code></pre></div><p>接下来，我们为项目添加所需的编译器警告标志。由于警告标志因编译器而异，因此我们使用<code>COMPILE_LANG_AND_ID</code>生成器表达式来控制在给定语言和一组编译器 ID 的情况下应应用的标志，如下所示：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">set</span><span class="token punctuation">(</span>gcc_like_cxx <span class="token string">&quot;$&lt;COMPILE_LANG_AND_ID:CXX,ARMClang,AppleClang,Clang,GNU&gt;&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>msvc_cxx <span class="token string">&quot;$&lt;COMPILE_LANG_AND_ID:CXX,MSVC&gt;&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">target_compile_options</span><span class="token punctuation">(</span>tutorial_compiler_flags <span class="token namespace">INTERFACE</span>
  <span class="token string">&quot;$&lt;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">gcc_like_cxx</span><span class="token punctuation">}</span></span>:$&lt;BUILD_INTERFACE:-Wall;-Wextra;-Wshadow;-Wformat=2;-Wunused&gt;&gt;&quot;</span>
  <span class="token string">&quot;$&lt;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">msvc_cxx</span><span class="token punctuation">}</span></span>:$&lt;BUILD_INTERFACE:-W3&gt;&gt;&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><p>查看此内容，我们看到警告标志封装在<code>BUILD_INTERFACE</code>条件内。这样做是为了使我们已安装项目的使用者不会继承我们的警告标志。</p> <h1 id="添加导出配置"><a href="#添加导出配置" class="header-anchor">#</a> 添加导出配置</h1> <p>在教程的“安装和测试”中，我们添加了 CMake 安装项目的库和头文件的功能。在”构建安装程序“期间，我们添加了打包这些信息的功能，以便可以将其分发给其他人。</p> <p>下一步是添加必要的信息，以便其他 CMake 项目可以使用我们的项目，无论是从构建目录，本地安装还是打包时。</p> <p>第一步是更新我们的<code>install（TARGETS）</code>命令，不仅要指定<code>DESTINATION</code>，还要指定<code>EXPORT</code>。 <code>EXPORT</code>关键字生成并安装一个<code>CMake</code>文件，该文件包含用于从安装树中导入<code>install</code>命令中列出的所有目标的代码。因此，让我们继续，通过更新<code>MathFunctions/CMakeLists.txt</code>中的<code>install</code>命令，显式导出<code>MathFunctions</code>库，如下所示：</p> <p>现在我们已经导出了<code>MathFunctions</code>，我们还需要显式安装生成的<code>MathFunctionsTargets.cmake</code>文件。通过将以下内容添加到顶层的<code>CMakeLists.txt</code>的底部来完成：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">install</span><span class="token punctuation">(</span>EXPORT MathFunctionsTargets
  FILE MathFunctionsTargets.cmake
  DESTINATION lib/cmake/MathFunctions
<span class="token punctuation">)</span>
</code></pre></div><p>然后尝试构建项目，应该会遇到类似下面的错误：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>CMake Error <span class="token keyword">in</span> MathFunctions/CMakeLists.txt:
  Target <span class="token string">&quot;MathFunctions&quot;</span> INTERFACE_INCLUDE_DIRECTORIES property contains
  path:

    <span class="token string">&quot;/Users/wmc/vscode/cmake/tutorial/MathFunctions&quot;</span>

  <span class="token function">which</span> is prefixed <span class="token keyword">in</span> the <span class="token builtin class-name">source</span> directory.
</code></pre></div><p>CMake 试图说的是，在生成导出信息的过程中，它将导出与当前机器上的绝对路径，在其他机器上无效。解决方案是更新<code>MathFunctions</code>的 <code>target_include_directories()</code>，以让 CMake 了解当从构建目录内和从安装/包中使用时，它需要不同的 INTERFACE 位置。这意味着将<code>MathFunctions</code>的<code>target_include_directories()</code>调用转换为如下样子:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>MathFunctions
                           <span class="token namespace">INTERFACE</span>
                            <span class="token punctuation">$&lt;</span>BUILD_INTERFACE:<span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span><span class="token punctuation">&gt;</span>
                            <span class="token punctuation">$&lt;</span>INSTALL_INTERFACE:include<span class="token punctuation">&gt;</span>
                           <span class="token punctuation">)</span>
</code></pre></div><p>修改后重新运行 CMake，应该不会再有警告了。</p> <p>此时，我们已经让 CMake 正确地打包了所需的目标信息，但我们仍然需要生成一个<code>MathFunctionsConfig.cmake</code>，这样<code>CMake find_package()</code>命令才能找到我们的项目。所以我们继续在项目的顶层添加一个新文件，名为<code>Config.cmake.in</code>，内容如下。</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code>@PACKAGE_INIT@

<span class="token keyword">include</span> <span class="token punctuation">(</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_LIST_DIR</span><span class="token punctuation">}</span></span>/MathFunctionsTargets.cmake&quot;</span> <span class="token punctuation">)</span>
</code></pre></div><p>然后，为了正确配置和安装该文件，在顶层<code>CMakeLists.txt</code>的底部添加以下内容:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">include</span><span class="token punctuation">(</span>CMakePackageConfigHelpers<span class="token punctuation">)</span>
<span class="token comment"># generate the config file that is includes the exports</span>
<span class="token function">configure_package_config_file</span><span class="token punctuation">(</span><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>/Config.cmake.in
  <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/MathFunctionsConfig.cmake&quot;</span>
  INSTALL_DESTINATION <span class="token string">&quot;lib/cmake/example&quot;</span>
  NO_SET_AND_CHECK_MACRO
  NO_CHECK_REQUIRED_COMPONENTS_MACRO
  <span class="token punctuation">)</span>
<span class="token comment"># generate the version file for the config file</span>
<span class="token function">write_basic_package_version_file</span><span class="token punctuation">(</span>
  <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/MathFunctionsConfigVersion.cmake&quot;</span>
  <span class="token property">VERSION</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">Tutorial_VERSION_MAJOR</span><span class="token punctuation">}</span></span>.<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">Tutorial_VERSION_MINOR</span><span class="token punctuation">}</span></span>&quot;</span>
  COMPATIBILITY AnyNewerVersion
<span class="token punctuation">)</span>

<span class="token comment"># install the configuration file</span>
<span class="token keyword">install</span><span class="token punctuation">(</span>FILES
  <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/MathFunctionsConfig.cmake
  DESTINATION lib/cmake/MathFunctions
  <span class="token punctuation">)</span>
</code></pre></div><p>此时，我们已经为我们的项目生成了一个可重定位的 CMake 配置，可以在项目安装或打包后使用。如果我们希望我们的项目也能在构建目录下使用，我们只需要在顶层 <code>CMakeLists.txt</code>的底部添加以下内容:</p> <p>通过这个<code>export</code>调用，我们现在可以生成一个<code>Targets.cmake</code>，允许构建目录下配置的<code>MathFunctionsConfig.cmake</code>被其他项目使用，而不需要安装它。</p> <h1 id="打包-debug-和-release"><a href="#打包-debug-和-release" class="header-anchor">#</a> 打包 Debug 和 Release</h1> <p>注意：这个例子对单配置生成器有效，对多配置生成器（如 Visual Studio）无效。</p> <p>默认情况下，CMake 的模型是一个构建目录只包含一个配置，无论是 Debug、Release、MinSizeRel，还是 RelWithDebInfo。然而，我们可以设置 CPack 来捆绑多个构建目录，并构建一个包含同一项目多个配置的包。</p> <p>首先，我们要确保 Debug 版本和 Release 版本构建的可执行文件和库使用不同的名称。让我们使用 d 作为 Debug 版可执行文件和库的后缀。</p> <p>在顶层的<code>CMakeLists.txt</code>文件开始处添加：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_DEBUG_POSTFIX</span> d<span class="token punctuation">)</span>

<span class="token keyword">add_library</span><span class="token punctuation">(</span>tutorial_compiler_flags <span class="token namespace">INTERFACE</span><span class="token punctuation">)</span>
</code></pre></div><p>以及<code>TUtorial</code>可执行文件上的 DEBUG_POSTFIX 属性:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">add_executable</span><span class="token punctuation">(</span>Tutorial tutorial.cxx<span class="token punctuation">)</span>
<span class="token keyword">set_target_properties</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PROPERTIES</span> <span class="token property">DEBUG_POSTFIX</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_DEBUG_POSTFIX</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>Tutorial <span class="token namespace">PUBLIC</span> MathFunctions<span class="token punctuation">)</span>
</code></pre></div><p>我们也给<code>MathFunctions</code>库添加版本号。在<code>MathFunctions/CMakeLists.txt</code>中，设置<code>VERSION</code>和<code>SOVERSION</code>属性:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">set_property</span><span class="token punctuation">(</span>TARGET MathFunctions PROPERTY <span class="token property">VERSION</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set_property</span><span class="token punctuation">(</span>TARGET MathFunctions PROPERTY <span class="token property">SOVERSION</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>在项目根目录下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> -p step12_build/<span class="token punctuation">{</span>debug,release<span class="token punctuation">}</span>
</code></pre></div><p>现在我们需要设置 debug 和 release 版本。我们可以使用<code>CMAKE_BUILD_TYPE</code>来设置配置类型：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> debug
cmake -DCMAKE_BUILD_TYPE<span class="token operator">=</span>Debug <span class="token punctuation">..</span>/<span class="token punctuation">..</span>
cmake --build <span class="token builtin class-name">.</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/release
cmake -DCMAKE_BUILD_TYPE<span class="token operator">=</span>Release <span class="token punctuation">..</span>/<span class="token punctuation">..</span>
cmake --build <span class="token builtin class-name">.</span>
</code></pre></div><p>现在调试和发行版的构建都已经完成，我们可以使用一个自定义的配置文件将两个构建打包成一个发行版。在 step12_build 目录下，创建一个名为<code>MultiCPackConfig.cmake</code>的文件。在这个文件中，首先包含 cmake 可执行文件创建的默认配置文件</p> <p>接下来，使用<code>CPACK_INSTALL_CMAKE_PROJECTS</code>变量来指定要安装的项目。在本例中，我们希望同时安装 debug 和 release 版本：</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">&quot;release/CPackConfig.cmake&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">(</span>CPACK_INSTALL_CMAKE_PROJECTS
    <span class="token string">&quot;debug;Tutorial;ALL;/&quot;</span>
    <span class="token string">&quot;release;Tutorial;ALL;/&quot;</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>在 step12_build 目录下，运行<code>cpack</code>，用<code>config</code>选项指定我们的自定义配置文件:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cpack --config MultiCPackConfig.cmake
</code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#开始项目" title="开始项目">开始项目</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加版本号并配置头文件" title="添加版本号并配置头文件">添加版本号并配置头文件</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#构建并测试" title="构建并测试">构建并测试</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#安装规则" title="安装规则">安装规则</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#测试支持" title="测试支持">测试支持</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#指定编译定义" title="指定编译定义">指定编译定义</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/jason210314" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2018-present</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f25a4321.js" defer></script><script src="/assets/js/6.036fc43e.js" defer></script><script src="/assets/js/3.e3d55509.js" defer></script><script src="/assets/js/33.89c22683.js" defer></script><script src="/assets/js/9.151ac344.js" defer></script>
  </body>
</html>
