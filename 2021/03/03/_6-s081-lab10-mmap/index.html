<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.S081 lab10 mmap | OneStep</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="alternate" type="application/rss+xml" href="https://wmc1999.top/rss.xml" title="OneStep RSS Feed">
    <meta name="description" content="为xv6添加mmap支持">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.e4481a5a.css" as="style"><link rel="preload" href="/assets/js/app.acf8092b.js" as="script"><link rel="preload" href="/assets/js/6.036fc43e.js" as="script"><link rel="preload" href="/assets/js/3.e3d55509.js" as="script"><link rel="preload" href="/assets/js/14.f7c31146.js" as="script"><link rel="preload" href="/assets/js/9.151ac344.js" as="script"><link rel="prefetch" href="/assets/js/10.e077d793.js"><link rel="prefetch" href="/assets/js/11.93b1eff1.js"><link rel="prefetch" href="/assets/js/12.165a8f38.js"><link rel="prefetch" href="/assets/js/13.86b71190.js"><link rel="prefetch" href="/assets/js/15.b61267d7.js"><link rel="prefetch" href="/assets/js/16.e7b2390a.js"><link rel="prefetch" href="/assets/js/17.c6ea5fff.js"><link rel="prefetch" href="/assets/js/18.678082c9.js"><link rel="prefetch" href="/assets/js/19.21a8a34e.js"><link rel="prefetch" href="/assets/js/20.9edcae00.js"><link rel="prefetch" href="/assets/js/21.f0f9d500.js"><link rel="prefetch" href="/assets/js/22.b54c9990.js"><link rel="prefetch" href="/assets/js/23.53b24cbf.js"><link rel="prefetch" href="/assets/js/24.659f2811.js"><link rel="prefetch" href="/assets/js/25.d1cafbf8.js"><link rel="prefetch" href="/assets/js/26.b17873ae.js"><link rel="prefetch" href="/assets/js/27.2aa200a3.js"><link rel="prefetch" href="/assets/js/28.15123e9b.js"><link rel="prefetch" href="/assets/js/29.f9430524.js"><link rel="prefetch" href="/assets/js/30.ea435c6a.js"><link rel="prefetch" href="/assets/js/31.cefe08f6.js"><link rel="prefetch" href="/assets/js/32.df4e8226.js"><link rel="prefetch" href="/assets/js/33.ba689688.js"><link rel="prefetch" href="/assets/js/34.55f32c39.js"><link rel="prefetch" href="/assets/js/35.5b664f83.js"><link rel="prefetch" href="/assets/js/36.f179d54b.js"><link rel="prefetch" href="/assets/js/37.11846bd5.js"><link rel="prefetch" href="/assets/js/4.d1c52263.js"><link rel="prefetch" href="/assets/js/5.ed205acd.js"><link rel="prefetch" href="/assets/js/7.43914937.js"><link rel="prefetch" href="/assets/js/8.21172198.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.dfe54976.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4481a5a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">OneStep </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="nav-item"><a href="/about/" class="nav-link">About </a></li><li class="nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">OneStep </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About </a></li><li class="mobile-nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        6.S081 lab10 mmap
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-03-03T16:35:52.000Z">
      2021-03-03
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/6.S081" data-v-42ccfcd5><span data-v-42ccfcd5>6.S081</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/mmap" data-v-42ccfcd5><span data-v-42ccfcd5>mmap</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p><code>mmap</code>和<code>munmap</code>系统调用允许 UNIX 程序对其地址空间进行更为细致的控制。它们可用于在进程间共享内存，将文件映射到进程地址空间，并作为用户级<code>page fault</code>方案的一部分。在本实验室中，我们将在<code>xv6</code>中添加<code>mmap</code>和<code>munmap</code>系统调用，重点是<code>memory-mapped files</code>。</p> <h1 id="lab-mmap"><a href="#lab-mmap" class="header-anchor">#</a> Lab: mmap</h1> <p><code>mmap</code>的 API 如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
           <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>xv6</code>中，<code>addr</code>始终为 0，所以由<code>kernel</code>自行判断应当 map 的地址；<code>prot</code>表示了 mapped memory 的 R、W、X 权限，<code>flags</code>为<code>MAP_SHARED</code>或者<code>MAP_PRIVATE</code>，前者表示对 mapped memory 的修改应写回文件，后者则不需要；<code>offer</code>永远为 0，不用处理文件的偏移量；mmap 成功将返回对应内存起始地址；失败返回<code>0xffffffffffffffff</code>。</p> <p><code>munmap(addr, length)</code>需要将从 addr 开始的长度为<code>length</code>的内存<code>unmap</code>。实验指导书保证被<code>munmap</code>的这段内存位于<code>mmap</code>内存区间的头部/尾部或者是全部，<code>munmap</code>不会在中间挖一个洞；当内存是以<code>MAP_SHARED</code>模式被<code>mmap</code>时，需要先将修改写回文件。</p> <p>看完了对于<code>mmap</code>和<code>munmap</code>的要求，发现其实测试没有一些比较难的<code>case</code>，为我们的实现提供了便利。</p> <p>之后，就可以跟着 hints 完成实验：</p> <ul><li><p>首先添加<code>mmap</code>和<code>munmap</code>的系统调用声明，并且在<code>Makefile</code>中加入<code>_mmaptest</code>。</p></li> <li><p>对 mapped memory 要使用 lazy allocation，就像在之前的实验中那样，这样子使得我们可以在物理内存有限的情况下<code>mmap</code>尽可能大的文件。</p></li> <li><p>记录<code>mmap</code>为每个进程 map 文件的情况，例如地址，长度，权限，对应的文件等等。由于<code>xv6</code>没有真正的内存分配器，所以我们使用一个定长的数组去存储，16 就足够了。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">VMA</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> used<span class="token punctuation">;</span>
  uint64 addr<span class="token punctuation">;</span>
  uint64 end<span class="token punctuation">;</span>
  <span class="token keyword">int</span> prot<span class="token punctuation">;</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span> offset<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// in struct proc</span>
<span class="token keyword">struct</span> <span class="token class-name">VMA</span> vma<span class="token punctuation">[</span>NVMA<span class="token punctuation">]</span><span class="token punctuation">;</span>
uint64 mmap_start<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>实现<code>mmap</code>，从用户地址空间找到空闲处 map 文件，修改对应的<code>VMA</code>结构体记录，当对文件<code>mmap</code>后，应当增加文件的引用计数(<code>filedup</code>)，这样当文件被关闭时，<code>VMA</code>持有的文件指针才不会失效。</p> <p>最重要的就是找到合适的空闲地址，用于<code>mmap</code>。<code>xv6</code>的用户地址空间如下图：</p> <p><img src="/assets/img/image-20210303172730172.ee87e578.png" alt="image-20210303172730172"></p> <p>最顶部是<code>trampoline</code>和<code>trapframe</code>，它们占用了两个 page，和<code>stack</code>之间有很大的空闲地址，我们可以将文件 map 到<code>trapframe</code>之下，不断向下增长，<code>mmap_start</code>记录着<code>trapframe</code>下可用于<code>mmap</code>的起始地址，初始值为<code>PGROUNDDOWN(MAXVA - (2 * PGSIZE))</code>。</p> <div class="language-c extra-class"><pre class="language-c"><code>uint64
<span class="token function">sys_mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> length<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prot<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>
    <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argfd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0xffffffffffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-&gt;</span>writable <span class="token operator">&amp;&amp;</span> flags <span class="token operator">==</span> MAP_SHARED <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0xffffffffffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// find a vma</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">VMA</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>v <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">;</span> v <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>v<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">==</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">filedup</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>mmap_start <span class="token operator">-</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>end <span class="token operator">=</span> v<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> length<span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>mmap_start <span class="token operator">=</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">;</span>

  v<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>f <span class="token operator">=</span> f<span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>prot <span class="token operator">=</span> prot<span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
  v<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>当发生<code>page fault</code>时，为其分配一个真实的物理页面，使用<code>readi</code>将文件内容读入内存，然后将物理页面 map 到用户地址空间，记得正确设置页面的权限。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span> <span class="token operator">||</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint64 va <span class="token operator">=</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">&gt;</span> MAXVA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p<span class="token operator">-&gt;</span>killed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mmap_alloc</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token operator">-&gt;</span>killed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">int</span>
<span class="token function">mmap_alloc</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">VMA</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
  <span class="token comment">// find vma struct</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>v <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">;</span> v <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>used <span class="token operator">&amp;&amp;</span> va <span class="token operator">&gt;=</span> v<span class="token operator">-&gt;</span>addr <span class="token operator">&amp;&amp;</span> va <span class="token operator">&lt;</span> v<span class="token operator">-&gt;</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ilock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> len<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">readi</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> va <span class="token operator">-</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">iunlock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">iunlock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> f <span class="token operator">=</span> PTE_U <span class="token operator">|</span> <span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>prot <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>实现<code>munmap</code>，找到对应的<code>VMA</code>，使用<code>uvmunmap</code> unmap 对应的内存，当一个<code>mmap</code>的所有内存都被 unmap 时，需要减少对应文件的引用计数；如果内存被修改过，且是以<code>MAP_SHARED</code>模式被<code>mmap</code>，那么需要先将内存内容写回文件。理想态下，我们只应当写回<code>dirty page</code>，但是测试中不会检查这一点，所以将所有内存写回文件即可了。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span>
<span class="token function">fileundup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;filedup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  f<span class="token operator">-&gt;</span>ref<span class="token operator">--</span><span class="token punctuation">;</span>

  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

uint64
<span class="token function">sys_munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  uint64 addr<span class="token punctuation">;</span>
  <span class="token keyword">int</span> length<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">s_munmap</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

uint64
<span class="token function">s_munmap</span><span class="token punctuation">(</span>uint64 addr<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">VMA</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>v <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">;</span> v <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>used <span class="token operator">&amp;&amp;</span> v<span class="token operator">-&gt;</span>addr <span class="token operator">&lt;=</span> addr <span class="token operator">&amp;&amp;</span> addr <span class="token operator">+</span> length <span class="token operator">&lt;=</span> v<span class="token operator">-&gt;</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">==</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  uint64 end <span class="token operator">=</span> addr <span class="token operator">+</span> length<span class="token punctuation">;</span>
  uint64 _addr <span class="token operator">=</span> addr<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>addr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if already load in</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>flags <span class="token operator">==</span> MAP_SHARED <span class="token operator">&amp;&amp;</span> v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ilock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>end<span class="token operator">-</span>addr<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">writei</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> addr <span class="token operator">-</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">iunlock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">iunlock</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    addr <span class="token operator">+=</span> PGSIZE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>_addr <span class="token operator">==</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v<span class="token operator">-&gt;</span>addr <span class="token operator">+=</span> length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>_addr <span class="token operator">+</span> length <span class="token operator">==</span> v<span class="token operator">-&gt;</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v<span class="token operator">-&gt;</span>end <span class="token operator">-=</span> length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>addr <span class="token operator">==</span> v<span class="token operator">-&gt;</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fileundup</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现时遇到两个坑：</p> <ul><li>在<code>uvmunmap</code>时，首先要判断该内存是否真的被<code>lazy allocation</code>了，否则要像<code>lazy</code>lab 中一样，修改<code>uvmunmap</code>，我觉得这样实现比较 ugly，因为破坏了<code>uvmunmap</code>发现错误的功能。</li> <li>最开始实现时，只要<code>v-&gt;flags == MAP_SHARED</code>就将文件写回，结果在<code>forktest</code>中父子进程内存内容不一致，查看<code>forktest</code>代码发现原来创建的只读文件，只要<code>prot</code>不标志为可写，那么制度文件也是可以用<code>MAP_SHARED</code>模式进行<code>mmap</code>的。所以还要加上<code>v-&gt;f-&gt;writable</code>或者<code>prot &amp; PROT_WRITE</code>。</li></ul></li> <li><p>修改<code>exit</code>代码，使得<code>exit</code>被调用后，unmap 所有被<code>mmap</code>的内存。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">VMA</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>v <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">;</span> v <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>vma <span class="token operator">+</span> NVMA<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">s_munmap</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> v<span class="token operator">-&gt;</span>end <span class="token operator">-</span> v<span class="token operator">-&gt;</span>addr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;exit:munmap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>修改 fork 代码，使得子进程拥有和父进程相同的<code>mmap</code>文件。可以直接为子进程分配新的物理内存用于<code>mmap</code>，不用共享相同物理页面。</p> <div class="language-c extra-class"><pre class="language-c"><code>np<span class="token operator">-&gt;</span>mmap_start <span class="token operator">=</span> p<span class="token operator">-&gt;</span>mmap_start<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">;</span>
  np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end<span class="token punctuation">;</span>
  np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token punctuation">;</span>
  np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot<span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">&amp;&amp;</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f <span class="token operator">=</span> <span class="token function">filedup</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>这样 mmap lab 就完成了，最终代码见<a href="https://github.com/Jason210314/xv6-labs-2020/tree/mmap" target="_blank" rel="noopener noreferrer">GitHub 仓库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/jason210314" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2018-present</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.acf8092b.js" defer></script><script src="/assets/js/6.036fc43e.js" defer></script><script src="/assets/js/3.e3d55509.js" defer></script><script src="/assets/js/14.f7c31146.js" defer></script><script src="/assets/js/9.151ac344.js" defer></script>
  </body>
</html>
